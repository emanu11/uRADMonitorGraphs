<html>
<head>
    <title>gauge.js</title>
    <link href="assets/main.css?v=5" type="text/css" rel="stylesheet">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Amaranth:400,700|Just+Another+Hand' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="assets/gauge.min.js"></script>
    <script type="text/javascript" src="assets/utils.js"></script>


    <script type="text/javascript">
        var userid = "6716";
        var userkey = "e0361c75aabf6ecc23cbf439604f3df5";
        var device = "160000FD"
    </script>
</head>

<body style="padding:10px;">
    <div  class="row">
        <div id="sensor-gauges" class="col-md-6">
           
        </div>
        <div class="col-md-6">
            
        </div>
    </div>
    
</body>
</html>

<script>
        var currentData = [];
        var last24HoursAverageData = [];
        var capabilities = [];
        var tresholds = [];
        var gauges = [];

        function getDevices() {
            $.ajax({
                type: 'GET',
                url: "http://data.uradmonitor.com/api/v1/devices",
                dataType: 'json',
                headers: { 'Content-Type': 'text/plain', 'X-User-id': userid, 'X-User-hash': userkey },
                success: function (data) {
                    data.forEach(function (item) { console.log(item.id) });
                },
                async: true
            });
        }
        function getDeviceStatus(device) {
            $.ajax({
                type: 'GET',
                url: "http://data.uradmonitor.com/api/v1/devices/",
                dataType: 'json',
                headers: { 'Content-Type': 'text/plain', 'X-User-id': userid, 'X-User-hash': userkey },
                success: function (data) {
                    data.forEach(function (item) {
                        if (device == item.id) {
                            console.log("Status " + item.status);
                            if (item.status == 1)
                                getDeviceCapabilities(device);
                        }
                    });
                },
                async: true
            });
        }
        async function getDeviceCapabilities(device) {
            await $.ajax({
                type: 'GET',
                url: "http://data.uradmonitor.com/api/v1/devices/" + device,
                dataType: 'json',
                headers: { 'Content-Type': 'text/plain', 'X-User-id': userid, 'X-User-hash': userkey },
                success: function (data) {
                    console.log("__________Device capabilities_____________");
                    Object.keys(data).forEach(function eachKey(key) {
                        capabilities.push(new DeviceCapability(key, data[key][0], data[key][1]));

                        t = getTresholds(key);
                        if (t)
                            tresholds.push(new SensorTresholds(key, t));
                    });
                    console.log(capabilities);
                    console.log(tresholds);

                    createGauges();
                    getLast24HoursData(device, "all");
                    getCurrentData(device, "all");
                },
                async: true
            });
        }
        function getLast24HoursData(device, sensor) {
            var now = Math.round(moment() / 1000)
            var end = Math.round(moment() / 1000);
            var start = Math.round(moment().subtract(24, 'hour'));

            //console.log("https://data.uradmonitor.com/api/v1/devices/" + device + "/" + sensor + "/" + (now - start) + "/" + (now - end));
            $.ajax({
                type: 'GET',
                url: "https://data.uradmonitor.com/api/v1/devices/" + device + "/" + sensor + "/" + (now - start) + "/" + (now - stop),
                dataType: 'json',
                headers: { 'Content-Type': 'text/plain', 'X-User-id': userid, 'X-User-hash': userkey },
                success: function (data, status) {
                    if (status != 'success') {
                        console.log("fail");
                    }
                    else {
                        console.log("____________Last 24 hours average data___________________");
                        capabilities.forEach(function (deviceData) {
                            if (deviceData.id != 'timelocal' && deviceData.id != 'all')
                                last24HoursAverageData.push(new SensorData(deviceData.id, deviceData.name, deviceData.measurementUnit, arrayAvg(data.map(function (o) { return o[deviceData.id]; })).toFixed(2)));
                        });
                        //populate gauges
                        last24HoursAverageData.forEach(function (sensorData) {
                            gauges.forEach(function (gaugeData) {
                                if (sensorData.id == gaugeData.id) {
                                    gaugeData.gauge.set(sensorData.value);
                                }
                            });
                        })
                    }
                },
                async: true
            });
        }
        function getCurrentData(device, sensor) {
            $.ajax({
                type: 'GET',
                url: "https://data.uradmonitor.com/api/v1/devices/" + device + "/" + sensor + "/60/0",
                dataType: 'json',
                headers: { 'Content-Type': 'text/plain', 'X-User-id': userid, 'X-User-hash': userkey },
                success: function (data, status) {
                    if (status != 'success') {
                        console.log("fail");
                    }
                    else {
                        console.log("____________Current data___________________");
                        capabilities.forEach(function (capability) {
                            Object.keys(data[0])
                                .forEach(function eachKey(key) {
                                    if (key == capability.id)
                                        currentData.push(new SensorData(capability.id, capability.name, capability.measurementUnit, data[0][key]));
                                });
                        });
                        console.log(currentData);
                        console.log("___________________________________________");
                    }
                },
                async: true
            });
        }

        function createGauges() {
            //this will render all the gauges based on the static values from getTresholds();
            tresholds.forEach(function (treshold) {

                const div = document.createElement('div');
                var gaugeid = treshold.name + '-gauge';
                div.className = 'col-md-4 gauge-container';
                div.innerHTML = '<canvas width=500 height=300 class="gauge" id="' + gaugeid + '"></canvas><div id="' + gaugeid + '-textfield" class="gauge-textfield"></div>';
                document.getElementById('sensor-gauges').appendChild(div);

                //create gauge
                gauge = new Gauge(document.getElementById(gaugeid));
                var opts = {
                    angle: -0.25,
                    lineWidth: 0.2,
                    pointer: {
                        length: 0.6,
                        strokeWidth: 0.05,
                        color: '#000000'
                    },
                    //create gauge limits
                    staticZones: [
                        { strokeStyle: treshold.limits[0].color, min: treshold.limits[0].low, max: treshold.limits[0].high },
                        { strokeStyle: treshold.limits[1].color, min: treshold.limits[1].low, max: treshold.limits[1].high },
                        { strokeStyle: treshold.limits[2].color, min: treshold.limits[2].low, max: treshold.limits[2].high },
                        { strokeStyle: treshold.limits[3].color, min: treshold.limits[3].low, max: treshold.limits[3].high },
                        { strokeStyle: treshold.limits[4].color, min: treshold.limits[4].low, max: treshold.limits[4].high },
                    ],
                    limitMax: false,
                    limitMin: false,
                    strokeColor: '#E0E0E0',
                    highDpiSupport: true
                };

                gauge.minValue = treshold.limits[0].low;
                gauge.maxValue = treshold.limits[4].high;
                gauge.setOptions(opts);
                gauge.setTextField(document.getElementById(gaugeid + "-textfield"));

                gauges.push({ "id": treshold.name, "gauge": gauge });
            });
        }

</script>
<script>
        //selectGauge3 = new Gauge(document.getElementById("gaugeee"));
        //var opts = {
        //    angle: -0.25,
        //    lineWidth: 0.2,
        //    pointer: {
        //        length: 0.6,
        //        strokeWidth: 0.05,
        //        color: '#000000'
        //    },
        //    staticZones: [
        //        { strokeStyle: "#30B32D", min: 0, max: 200 },
        //        { strokeStyle: "#FFDD00", min: 200, max: 400 },
        //        { strokeStyle: "#F03E3E", min: 400, max: 600 },
        //        { strokeStyle: "#F03E3E", min: 600, max: 800 },
        //    ],
        //    limitMax: false,
        //    limitMin: false,
        //    strokeColor: '#E0E0E0',
        //    highDpiSupport: true
        //};

        //selectGauge3.minValue = 0;
        //selectGauge3.maxValue = 800;
        //selectGauge3.setOptions(opts);
        //selectGauge3.setTextField(document.getElementById("gauge-textfield"));
        //selectGauge3.set(400);
</script>
<script>


        getDevices();
        getDeviceStatus(device);

</script>